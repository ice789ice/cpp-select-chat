# cpp-select-chat

一个使用 C++17 + `select()` 实现的简易 TCP 聊天室示例，支持多客户端连接、昵称、广播与空闲连接清理。适合作为网络编程入门和面试讲解项目。

## 功能
- 基于 `select()` 的单线程多路复用
- 昵称握手（首次消息作为昵称）
- `/quit` 退出并广播离开通知
- 处理 `EINTR`、`EPIPE`、`ECONNRESET` 等常见异常
- 空闲连接超时清理（默认 60 秒）

## 目录结构
- `server.cpp`: 服务器端逻辑
- `client.cpp`: 客户端逻辑

## 编译
```bash
g++ -std=c++17 -O2 -Wall -Wextra -o server server.cpp
g++ -std=c++17 -O2 -Wall -Wextra -o client client.cpp
```

## 运行
1. 启动服务器：
```bash
./server
```
2. 另开终端启动客户端（可以多开几个）：
```bash
./client
```
3. 首次输入作为昵称，之后正常聊天；输入 `/quit` 退出。

## 设计模式与架构思路
- **Reactor 模式（基础形态）**：`select()` 充当事件分发器，主循环监听多个 fd，当 fd 可读时分发处理。
- **事件驱动模型**：网络事件触发处理逻辑，避免为每个连接创建线程，降低上下文切换开销。
- **连接对象抽象**：用 `Client` 结构体维护 `fd`、`nickname`、`last_active` 等连接状态。

## 关键实现点
- **`select()` 被信号打断**：处理 `EINTR`，直接重试，避免忙等和日志刷屏。
- **`FD_SETSIZE` 限制**：加入上限检查，避免 `FD_SET` 越界导致未定义行为。
- **广播发送失败处理**：当 `send` 返回 `EPIPE` / `ECONNRESET`，立即清理连接，避免对失效 fd 持续写入。
- **空闲连接回收**：`select` 加超时参数，定期扫描并清理长时间无活跃的连接。

## 常见问题与解决思路
- **为什么不用多线程？**
  - 目标是展示 I/O 多路复用；`select` 单线程足以支撑少量并发，逻辑清晰。
- **`select` 的性能瓶颈？**
  - 受 `FD_SETSIZE` 和 O(n) 扫描影响。更高并发建议使用 `poll` 或 `epoll`。
- **如何处理客户端异常断开？**
  - `recv` 返回 `0` / `send` 返回 `EPIPE` 时视为连接失效，立刻清理。
- **如何做心跳或超时检测？**
  - 利用 `select` 的超时参数，周期性检查 `last_active`，进行断开或发送心跳。

## 可扩展方向
- 支持命令协议（如 `/list`、`/who`）
- 将连接管理拆分为单独模块，便于测试
- 使用 `epoll` 替换 `select` 以提升扩展性
